name: Deploy to Locaweb

on:
  push:
    branches: [ "main", "master" ]  # Deploy quando push em main ou master
  workflow_dispatch:  # Permite deploy manual via GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js (for build scripts)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify directory structure
        run: |
          pwd
          ls -la
          echo "--- Checking sitemimo directory ---"
          if [ ! -d "sitemimo/public_html" ]; then
            echo "❌ ERROR: sitemimo/public_html directory does not exist"
            echo "This workflow is for the legacy site which is not tracked in git."
            echo "The current site is deployed via Vercel."
            echo "If you need to deploy the legacy site, ensure sitemimo/public_html exists in the repository."
            exit 1
          fi
          ls -la sitemimo/ 2>&1 || echo "sitemimo directory not found"
          echo "--- Checking public_html directory ---"
          ls -la sitemimo/public_html/ 2>&1 | head -20 || echo "public_html directory not found"
          echo "--- Checking build directory ---"
          ls -la sitemimo/public_html/build/ 2>&1 || echo "Build directory not found"
          echo "--- Checking for minify scripts ---"
          find sitemimo -name "minify-*.sh" -type f 2>&1 || echo "No minify scripts found"
      
      - name: Run CSS minification
        run: |
          WORK_DIR="sitemimo/public_html"
          if [ ! -d "$WORK_DIR" ]; then
            echo "Error: Directory $WORK_DIR does not exist"
            exit 1
          fi
          cd "$WORK_DIR" || exit 1
          pwd
          echo "--- Contents of current directory ---"
          ls -la
          echo "--- Checking for build directory ---"
          if [ ! -d "build" ]; then
            echo "Error: build directory does not exist in $(pwd)"
            exit 1
          fi
          ls -la build/
          if [ -f "build/minify-css.sh" ]; then
            chmod +x build/minify-css.sh
            ./build/minify-css.sh || echo "CSS minification completed with warnings"
            ls -la minified/*.css 2>/dev/null || echo "No CSS files found in minified/"
          else
            echo "Error: build/minify-css.sh not found in $(pwd)"
            exit 1
          fi
      
      - name: Run JS minification
        run: |
          WORK_DIR="sitemimo/public_html"
          cd "$WORK_DIR" || exit 1
          if [ -f "build/minify-js.sh" ]; then
            chmod +x build/minify-js.sh
            ./build/minify-js.sh || echo "JS minification completed with warnings"
            ls -la minified/*.js 2>/dev/null || echo "No JS files found in minified/"
          else
            echo "Error: build/minify-js.sh not found in $(pwd)"
            exit 1
          fi
      
      - name: Update ASSET_VERSION for cache busting
        run: |
          cd sitemimo/public_html
          ASSET_VERSION=$(date +%Y%m%d)
          echo "Updating ASSET_VERSION to: $ASSET_VERSION"
          # Update ASSET_VERSION in config.php using sed (GitHub Actions runs on Linux)
          sed -i "s/define('ASSET_VERSION', '[0-9]*');/define('ASSET_VERSION', '$ASSET_VERSION');/" config.php
          echo "✅ ASSET_VERSION updated to $ASSET_VERSION"
          # Verify the change
          grep "ASSET_VERSION" config.php | head -1
      
      - name: Setup PHP 8.x
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: xml, zip, gd, mbstring, iconv
      
      - name: Install PHP dependencies (Composer)
        run: |
          cd sitemimo/public_html
          if [ -f "composer.json" ]; then
            echo "Installing PHP dependencies via Composer..."
            echo "Current directory: $(pwd)"
            echo "PHP version: $(php -v | head -1)"
            php -m | head -20
            
            # Install Composer if not available
            if ! command -v composer &> /dev/null; then
              echo "Composer not found, downloading..."
              php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
              php composer-setup.php --install-dir=/tmp --filename=composer
              php -r "unlink('composer-setup.php');"
              COMPOSER_CMD="/tmp/composer"
            else
              COMPOSER_CMD="composer"
            fi
            
            echo "Using Composer: $COMPOSER_CMD"
            $COMPOSER_CMD --version
            
            # Install dependencies with verbose output
            echo "Running: $COMPOSER_CMD install --no-dev --optimize-autoloader --no-interaction"
            if ! $COMPOSER_CMD install --no-dev --optimize-autoloader --no-interaction; then
              echo "❌ ERROR: Composer install failed!"
              echo "Trying to diagnose the issue..."
              php -r "echo 'PHP extensions: '; print_r(get_loaded_extensions());"
              cat composer.json
              exit 1
            fi
            
            echo "✅ Composer dependencies installed"
            
            # Verify vendor directory structure
            echo "Verifying vendor directory..."
            if [ ! -d "vendor" ]; then
              echo "❌ ERROR: vendor/ directory does not exist after Composer install!"
              exit 1
            fi
            
            echo "Vendor directory size: $(du -sh vendor | cut -f1)"
            echo "Vendor directory contents:"
            ls -la vendor/ | head -20
            
            # Verify PhpSpreadsheet is installed
            if [ -d "vendor/phpoffice/phpspreadsheet" ]; then
              echo "✅ PhpSpreadsheet found in vendor/"
              echo "PhpSpreadsheet directory size: $(du -sh vendor/phpoffice/phpspreadsheet | cut -f1)"
              ls -la vendor/phpoffice/phpspreadsheet/src/PhpSpreadsheet/ | head -10
            else
              echo "❌ ERROR: PhpSpreadsheet not found in vendor/"
              echo "Listing vendor directory:"
              ls -la vendor/ 2>/dev/null || echo "vendor/ directory does not exist!"
              echo "Listing vendor/phpoffice/ if exists:"
              ls -la vendor/phpoffice/ 2>/dev/null || echo "vendor/phpoffice/ does not exist!"
              exit 1
            fi
            
            # Verify vendor/autoload.php exists
            if [ -f "vendor/autoload.php" ]; then
              echo "✅ vendor/autoload.php exists ($(du -h vendor/autoload.php | cut -f1))"
            else
              echo "❌ ERROR: vendor/autoload.php does not exist!"
              exit 1
            fi
            
            echo "✅ All Composer dependencies verified successfully"
          else
            echo "No composer.json found, skipping Composer install"
          fi
      
      - name: Clean files before deploy
        run: |
          cd sitemimo/public_html
          echo "Removing files that shouldn't be deployed..."
          # Remove documentation and build files
          find . -name "*.md" -type f -delete 2>/dev/null || true
          find . -name "README*" -type f -delete 2>/dev/null || true
          find . -name "CHANGELOG*" -type f -delete 2>/dev/null || true
          find . -name "VERSIONING*" -type f -delete 2>/dev/null || true
          find . -name "IMPROVEMENTS*" -type f -delete 2>/dev/null || true
          find . -name "NEXT-STEPS*" -type f -delete 2>/dev/null || true
          find . -name "SEO-OPTIMIZATION*" -type f -delete 2>/dev/null || true
          find . -name "STRUCTURE-ANALYSIS*" -type f -delete 2>/dev/null || true
          find . -name "AI-DEVELOPMENT-GUIDE*" -type f -delete 2>/dev/null || true
          find . -name "GOOGLE-*" -type f -delete 2>/dev/null || true
          find . -name "LICENSE*" -type f -delete 2>/dev/null || true
          find . -name "license.txt" -type f -delete 2>/dev/null || true
          find . -name "readme.html" -type f -delete 2>/dev/null || true
          # Remove verificar-instalacao.php (security)
          find . -name "verificar-instalacao.php" -type f -delete 2>/dev/null || true
          # Remove ALL .git directories (including nested ones) to prevent Git errors in FTP-Deploy-Action
          find . -type d -name ".git" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name ".git*" -delete 2>/dev/null || true
          # Remove other directories (but keep vendor if it exists)
          rm -rf .env* node_modules wp-* x6f7689 cache img_backup_* .DS_Store Thumbs.db build 2>/dev/null || true
          echo "Cleanup complete. Ready for deploy."
      
      - name: Verify FTP secrets are configured
        run: |
          if [ -z "${{ secrets.SFTP_HOST }}" ]; then
            echo "❌ ERROR: SFTP_HOST secret is not configured!"
            echo "Please configure SFTP_HOST, SFTP_USER, and SFTP_PASSWORD secrets in GitHub Settings > Secrets and variables > Actions"
            exit 1
          fi
          if [ -z "${{ secrets.SFTP_USER }}" ]; then
            echo "❌ ERROR: SFTP_USER secret is not configured!"
            exit 1
          fi
          if [ -z "${{ secrets.SFTP_PASSWORD }}" ]; then
            echo "❌ ERROR: SFTP_PASSWORD secret is not configured!"
            exit 1
          fi
          echo "✅ All FTP secrets are configured"
          echo "Server: ${{ secrets.SFTP_HOST }}"
          echo "User: ${{ secrets.SFTP_USER }}"
          USER_LEN=$(echo -n "${{ secrets.SFTP_USER }}" | wc -c)
          PASS_LEN=$(echo -n "${{ secrets.SFTP_PASSWORD }}" | wc -c)
          echo "User length: $USER_LEN characters"
          echo "Password length: $PASS_LEN characters"
          echo "Port: 21"
          echo "Protocol: FTP"
          echo "Remote path: ./public_html/ (relative to FTP root)"
          echo ""
          echo "⚠️  TROUBLESHOOTING:"
          echo "If authentication fails, verify:"
          echo "1. Password in GitHub secrets matches the FTP password in Locaweb panel"
          echo "2. No extra spaces before/after password in GitHub secrets"
          echo "3. User account is active in Locaweb panel"
          echo "4. Test credentials manually with FileZilla or similar FTP client"
      
      - name: Deploy to Locaweb via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.0.0
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: 21
          local-dir: "./sitemimo/public_html/"
          server-dir: "./public_html/"
          protocol: ftp
          exclude: |
            **/.git
            **/.git/**
            **/.git*
            **/.env*
            **/node_modules/**
            **/wp-*/
            **/x6f7689/**
            **/cache/**
            **/img_backup_*/
            **/*.md
            **/.DS_Store
            **/Thumbs.db
            **/build/**
            **/README*
            **/CHANGELOG*
            **/VERSIONING*
            **/IMPROVEMENTS*
            **/NEXT-STEPS*
            **/SEO-OPTIMIZATION*
            **/STRUCTURE-ANALYSIS*
            **/AI-DEVELOPMENT-GUIDE*
            **/GOOGLE-*
            **/LICENSE*
            **/license.txt
            **/readme.html
            **/verificar-instalacao.php