name: Deploy to Locaweb

on:
  push:
    branches: [ "main", "master" ]  # Deploy quando push em main ou master
  workflow_dispatch:  # Permite deploy manual via GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js (for build scripts)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify directory structure
        run: |
          ls -la
          ls -la "Site Mimo/public_html" || echo "Directory not found"
          ls -la "Site Mimo/public_html/build" || echo "Build directory not found"
      
      - name: Run CSS minification
        run: |
          cd "Site Mimo/public_html" || exit 1
          pwd
          ls -la build/ || echo "Build directory not found"
          if [ -f "build/minify-css.sh" ]; then
            chmod +x build/minify-css.sh
            ./build/minify-css.sh || echo "CSS minification completed with warnings"
            ls -la minified/*.css 2>/dev/null || echo "No CSS files found in minified/"
          else
            echo "Error: build/minify-css.sh not found"
            exit 1
          fi
      
      - name: Run JS minification
        run: |
          cd "Site Mimo/public_html" || exit 1
          if [ -f "build/minify-js.sh" ]; then
            chmod +x build/minify-js.sh
            ./build/minify-js.sh || echo "JS minification completed with warnings"
            ls -la minified/*.js 2>/dev/null || echo "No JS files found in minified/"
          else
            echo "Error: build/minify-js.sh not found"
            exit 1
          fi
      
      - name: Deploy to Locaweb via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.6
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          local_path: "./Site Mimo/public_html"
          remote_path: "/public_html"
          args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          exclude: |
            **/.git*
            **/.env*
            **/node_modules/**
            **/vendor/**
            **/wp-*/
            **/x6f7689/**
            **/cache/**
            **/img_backup_*/
            **/*.md
            **/.DS_Store
            **/Thumbs.db
            **/build/**
            **/README*
            **/CHANGELOG*
            **/VERSIONING*
            **/IMPROVEMENTS*
            **/NEXT-STEPS*
            **/SEO-OPTIMIZATION*
            **/STRUCTURE-ANALYSIS*
            **/AI-DEVELOPMENT-GUIDE*
            **/GOOGLE-*
            **/LICENSE*
            **/license.txt
            **/readme.html

