name: Deploy to Locaweb

on:
  push:
    branches: [ "main", "master" ]  # Deploy quando push em main ou master
  workflow_dispatch:  # Permite deploy manual via GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js (for build scripts)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify directory structure
        run: |
          pwd
          ls -la
          echo "--- Checking sitemimo directory ---"
          ls -la sitemimo/ 2>&1 || echo "sitemimo directory not found"
          echo "--- Checking public_html directory ---"
          ls -la sitemimo/public_html/ 2>&1 | head -20 || echo "public_html directory not found"
          echo "--- Checking build directory ---"
          ls -la sitemimo/public_html/build/ 2>&1 || echo "Build directory not found"
          echo "--- Checking for minify scripts ---"
          find sitemimo -name "minify-*.sh" -type f 2>&1 || echo "No minify scripts found"
      
      - name: Run CSS minification
        run: |
          WORK_DIR="sitemimo/public_html"
          if [ ! -d "$WORK_DIR" ]; then
            echo "Error: Directory $WORK_DIR does not exist"
            exit 1
          fi
          cd "$WORK_DIR" || exit 1
          pwd
          echo "--- Contents of current directory ---"
          ls -la
          echo "--- Checking for build directory ---"
          if [ ! -d "build" ]; then
            echo "Error: build directory does not exist in $(pwd)"
            exit 1
          fi
          ls -la build/
          if [ -f "build/minify-css.sh" ]; then
            chmod +x build/minify-css.sh
            ./build/minify-css.sh || echo "CSS minification completed with warnings"
            ls -la minified/*.css 2>/dev/null || echo "No CSS files found in minified/"
          else
            echo "Error: build/minify-css.sh not found in $(pwd)"
            exit 1
          fi
      
      - name: Run JS minification
        run: |
          WORK_DIR="sitemimo/public_html"
          cd "$WORK_DIR" || exit 1
          if [ -f "build/minify-js.sh" ]; then
            chmod +x build/minify-js.sh
            ./build/minify-js.sh || echo "JS minification completed with warnings"
            ls -la minified/*.js 2>/dev/null || echo "No JS files found in minified/"
          else
            echo "Error: build/minify-js.sh not found in $(pwd)"
            exit 1
          fi
      
      - name: Deploy to Locaweb via SFTP
        uses: wlixcc/SFTP-Deploy-Action@v1.2.6
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          local_path: "./sitemimo/public_html"
          remote_path: "/public_html"
          sftpArgs: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          rsyncArgs: "--exclude='.git*' --exclude='.env*' --exclude='node_modules' --exclude='vendor' --exclude='wp-*' --exclude='x6f7689' --exclude='cache' --exclude='img_backup_*' --exclude='*.md' --exclude='.DS_Store' --exclude='Thumbs.db' --exclude='build' --exclude='README*' --exclude='CHANGELOG*' --exclude='VERSIONING*' --exclude='IMPROVEMENTS*' --exclude='NEXT-STEPS*' --exclude='SEO-OPTIMIZATION*' --exclude='STRUCTURE-ANALYSIS*' --exclude='AI-DEVELOPMENT-GUIDE*' --exclude='GOOGLE-*' --exclude='LICENSE*' --exclude='license.txt' --exclude='readme.html'"

