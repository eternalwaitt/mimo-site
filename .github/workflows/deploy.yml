name: Deploy to Locaweb

on:
  push:
    branches: [ "main", "master" ]  # Deploy quando push em main ou master
  workflow_dispatch:  # Permite deploy manual via GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js (for build scripts)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify directory structure
        run: |
          pwd
          ls -la
          echo "--- Checking sitemimo directory ---"
          ls -la sitemimo/ 2>&1 || echo "sitemimo directory not found"
          echo "--- Checking public_html directory ---"
          ls -la sitemimo/public_html/ 2>&1 | head -20 || echo "public_html directory not found"
          echo "--- Checking build directory ---"
          ls -la sitemimo/public_html/build/ 2>&1 || echo "Build directory not found"
          echo "--- Checking for minify scripts ---"
          find sitemimo -name "minify-*.sh" -type f 2>&1 || echo "No minify scripts found"
      
      - name: Run CSS minification
        run: |
          WORK_DIR="sitemimo/public_html"
          if [ ! -d "$WORK_DIR" ]; then
            echo "Error: Directory $WORK_DIR does not exist"
            exit 1
          fi
          cd "$WORK_DIR" || exit 1
          pwd
          echo "--- Contents of current directory ---"
          ls -la
          echo "--- Checking for build directory ---"
          if [ ! -d "build" ]; then
            echo "Error: build directory does not exist in $(pwd)"
            exit 1
          fi
          ls -la build/
          if [ -f "build/minify-css.sh" ]; then
            chmod +x build/minify-css.sh
            ./build/minify-css.sh || echo "CSS minification completed with warnings"
            ls -la minified/*.css 2>/dev/null || echo "No CSS files found in minified/"
          else
            echo "Error: build/minify-css.sh not found in $(pwd)"
            exit 1
          fi
      
      - name: Run JS minification
        run: |
          WORK_DIR="sitemimo/public_html"
          cd "$WORK_DIR" || exit 1
          if [ -f "build/minify-js.sh" ]; then
            chmod +x build/minify-js.sh
            ./build/minify-js.sh || echo "JS minification completed with warnings"
            ls -la minified/*.js 2>/dev/null || echo "No JS files found in minified/"
          else
            echo "Error: build/minify-js.sh not found in $(pwd)"
            exit 1
          fi
      
      - name: Clean files before deploy
        run: |
          cd sitemimo/public_html
          echo "Removing files that shouldn't be deployed..."
          # Remove documentation and build files
          find . -name "*.md" -type f -delete 2>/dev/null || true
          find . -name "README*" -type f -delete 2>/dev/null || true
          find . -name "CHANGELOG*" -type f -delete 2>/dev/null || true
          find . -name "VERSIONING*" -type f -delete 2>/dev/null || true
          find . -name "IMPROVEMENTS*" -type f -delete 2>/dev/null || true
          find . -name "NEXT-STEPS*" -type f -delete 2>/dev/null || true
          find . -name "SEO-OPTIMIZATION*" -type f -delete 2>/dev/null || true
          find . -name "STRUCTURE-ANALYSIS*" -type f -delete 2>/dev/null || true
          find . -name "AI-DEVELOPMENT-GUIDE*" -type f -delete 2>/dev/null || true
          find . -name "GOOGLE-*" -type f -delete 2>/dev/null || true
          find . -name "LICENSE*" -type f -delete 2>/dev/null || true
          find . -name "license.txt" -type f -delete 2>/dev/null || true
          find . -name "readme.html" -type f -delete 2>/dev/null || true
          # Remove directories
          rm -rf .git* .env* node_modules vendor wp-* x6f7689 cache img_backup_* .DS_Store Thumbs.db build 2>/dev/null || true
          echo "Cleanup complete. Ready for deploy."
      
      - name: Verify FTP secrets are configured
        run: |
          if [ -z "${{ secrets.SFTP_HOST }}" ]; then
            echo "❌ ERROR: SFTP_HOST secret is not configured!"
            echo "Please configure SFTP_HOST, SFTP_USER, and SFTP_PASSWORD secrets in GitHub Settings > Secrets and variables > Actions"
            exit 1
          fi
          if [ -z "${{ secrets.SFTP_USER }}" ]; then
            echo "❌ ERROR: SFTP_USER secret is not configured!"
            exit 1
          fi
          if [ -z "${{ secrets.SFTP_PASSWORD }}" ]; then
            echo "❌ ERROR: SFTP_PASSWORD secret is not configured!"
            exit 1
          fi
          echo "✅ All FTP secrets are configured"
          echo "Server: ${{ secrets.SFTP_HOST }}"
          echo "User: ${{ secrets.SFTP_USER }}"
          echo "Password: [HIDDEN]"
      
      - name: Deploy to Locaweb via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.0.0
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: 21
          local-dir: "./sitemimo/public_html/"
          server-dir: "./public_html/"
          protocol: ftps
          exclude: |
            **/.git*
            **/.env*
            **/node_modules/**
            **/vendor/**
            **/wp-*/
            **/x6f7689/**
            **/cache/**
            **/img_backup_*/
            **/*.md
            **/.DS_Store
            **/Thumbs.db
            **/build/**
            **/README*
            **/CHANGELOG*
            **/VERSIONING*
            **/IMPROVEMENTS*
            **/NEXT-STEPS*
            **/SEO-OPTIMIZATION*
            **/STRUCTURE-ANALYSIS*
            **/AI-DEVELOPMENT-GUIDE*
            **/GOOGLE-*
            **/LICENSE*
            **/license.txt
            **/readme.html

